#!/usr/bin/env bash
set -eu
set -x
: ${WORKDIR:=/var/tmp/tex4ht-sources-bootstrap}
if [[ ! -d "${WORKDIR}" ]]; then
    mkdir "${WORKDIR}"
fi
cd "${WORKDIR}"
if [[ ! -d tex4ht-svn ]]; then
    svn checkout https://svn.gnu.org.ua/sources/tex4ht tex4ht-svn
fi
pushd tex4ht-svn
TEX4HT_SVN_VERSION=$(svnversion)
popd
if [[ ! -d texmf-dist ]]; then
    wget wget https://mirrors.ctan.org/systems/texlive/tlnet/archive/tex4ht.tar.xz
    unp tex4ht.tar.xz
fi
if [[ ! -d bin ]]; then
    wget https://mirrors.ctan.org/systems/texlive/tlnet/archive/tex4ht.x86_64-linux.tar.xz
    unp tex4ht.x86_64-linux.tar.xz
fi
TEX4HT_BIN_DIR="${WORKDIR}/bin/x86_64-linux"

pushd tex4ht-svn/trunk/lit
# In theory, we only want the sources that are generated by the
# 't4ht.c', 'tex4ht.c', and 'jar' targets. However, that make
# invocation fails, so we simply make everything.
# PATH="${TEX4HT_BIN_DIR}:${PATH}" make do_java=0 t4ht.c tex4ht.c jar
PATH="${TEX4HT_BIN_DIR}:${PATH}" make do_java=0
popd
if [[ -d tex4ht-sources ]]; then
    rm -rf tex4ht-sources
fi
mkdir tex4ht-sources
mkdir tex4ht-sources/c
mkdir tex4ht-sources/java
mkdir tex4ht-sources/java/tex4ht

mv tex4ht-svn/trunk/lit/*.c tex4ht-sources/c
mv tex4ht-svn/trunk/lit/*.java tex4ht-sources/java/tex4ht
mv tex4ht-svn/trunk/lit/work.dir/src/* tex4ht-sources/java/

pushd tex4ht-sources
XZ_OPT='-T0 -9' tar -acf ../tex4ht-sources-${TEX4HT_SVN_VERSION}.tar.xz . 
popd

OUTPUT=$(realpath tex4ht-sources-${TEX4HT_SVN_VERSION}.tar.xz)
echo "Created $OUTPUT"
